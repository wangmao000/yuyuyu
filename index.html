<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>证书登记系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }
        .content-transition {
            transition: margin-left 0.3s ease-in-out;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
        }
        .login-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-row-hover:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateY(-1px);
        }
        .file-drag-over {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        .certificate-detail {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .status-pending { background-color: #fef3c7; color: #d97706; }
        .status-processing { background-color: #dbeafe; color: #1d4ed8; }
        .status-completed { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; }
        .chart-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        .required-mark {
            color: #dc2626;
        }
        .form-error {
            border-color: #dc2626 !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 登录页面 -->
    <div id="login-page" class="login-bg flex items-center justify-center min-h-screen p-4">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-500 hover:shadow-3xl">
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fa fa-certificate text-white text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">证书登记系统</h1>
                        <p class="text-gray-600 mt-2">请登录您的账户</p>
                    </div>

                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa fa-user text-gray-400"></i>
                                </div>
                                <input 
                                    type="text" 
                                    id="username" 
                                    name="username"
                                    required
                                    class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50"
                                    placeholder="请输入用户名"
                                >
                            </div>
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa fa-lock text-gray-400"></i>
                                </div>
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password"
                                    required
                                    class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50"
                                    placeholder="请输入密码"
                                >
                                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors">
                                    <i class="fa fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>

                        <button 
                            type="submit" 
                            id="login-button"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg flex items-center justify-center"
                        >
                            <i class="fa fa-sign-in mr-2"></i>登录
                            <i class="fa fa-spinner fa-spin ml-2 hidden" id="login-spinner"></i>
                        </button>
                    </form>

                    <div id="login-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden">
                        <div class="flex items-center">
                            <i class="fa fa-exclamation-circle text-red-500 mr-2"></i>
                            <span class="text-sm text-red-700">用户名或密码错误</span>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-sm font-medium text-blue-800 mb-2">测试账号</h3>
                        <div class="text-xs text-blue-600 space-y-1">
                            <div>管理员账号: admin / admin123</div>
                            <div>业务用户账号: user / user123</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主系统界面 -->
    <div id="main-system" class="hidden">
        <!-- 顶部导航栏 -->
        <header class="glass-effect shadow-sm border-b border-gray-200 sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200 transform hover:scale-105 group">
                        <i class="fa fa-bars text-gray-600 group-hover:text-blue-600 transition-colors"></i>
                    </button>
                    
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-certificate text-blue-600 text-xl"></i>
                        <h1 class="text-lg font-semibold text-gray-800">证书登记系统</h1>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 text-sm">
                        <div id="user-avatar" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-medium text-sm">
                            用
                        </div>
                        <div class="text-right">
                            <div id="user-name" class="font-medium text-gray-800">用户</div>
                            <div id="user-role" class="text-xs text-gray-500">角色</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-all group">
                        <i class="fa fa-sign-out text-gray-600 group-hover:text-red-600"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- 侧边栏 -->
            <aside id="sidebar" class="sidebar-transition glass-effect h-[calc(100vh-64px)] shadow-sm border-r border-gray-200 overflow-y-auto hide-scrollbar sticky top-16 w-64">
                <nav class="p-4">
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">证书管理</h3>
                        <div class="space-y-1">
                            <a href="#" class="nav-item active flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="certificate-list">
                                <i class="fa fa-list-alt w-5 text-center mr-3 text-blue-600"></i>
                                <span class="font-medium">证书列表</span>
                                <span class="ml-auto bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full" id="cert-count">0</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="add-certificate">
                                <i class="fa fa-plus-circle w-5 text-center mr-3 text-gray-500 group-hover:text-blue-500"></i>
                                <span class="text-gray-700 group-hover:text-blue-600">新增证书</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">统计分析</h3>
                        <div class="space-y-1">
                            <a href="#" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="statistics">
                                <i class="fa fa-bar-chart w-5 text-center mr-3 text-gray-500 group-hover:text-blue-500"></i>
                                <span class="text-gray-700 group-hover:text-blue-600">费用统计</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- 主内容区域 -->
            <main id="main-content" class="content-transition flex-1 min-h-[calc(100vh-64px)] p-6 ml-0">
                <div id="page-content" class="fade-in">
                    <!-- 动态内容 -->
                </div>
            </main>
        </div>
    </div>

    <!-- 新增证书模态框 -->
    <div id="add-certificate-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">新增证书</h3>
                <button id="close-certificate-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <form id="certificate-form" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                证书编号 <span class="required-mark">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="certificate-number"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入证书编号"
                            >
                            <div id="certificate-number-error" class="text-red-500 text-xs mt-1 hidden">
                                该证书编号已存在
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                申请时间 <span class="required-mark">*</span>
                            </label>
                            <input 
                                type="datetime-local" 
                                id="application-time"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                产品名称 <span class="required-mark">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="product-name"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入产品名称"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                客户名称 <span class="required-mark">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="customer-name"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入客户名称"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">计划号</label>
                            <input 
                                type="text" 
                                id="plan-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入计划号"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">合同号</label>
                            <input 
                                type="text" 
                                id="contract-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入合同号"
                            >
                        </div>
                        
                        <!-- 新增船级社字段 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">船级社</label>
                            <select id="classification-society" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="">请选择船级社</option>
                                <option value="CCS">中国船级社 (CCS)</option>
                                <option value="DNV">DNV</option>
                                <option value="ABS">美国船级社 (ABS)</option>
                                <option value="BV">法国船级社 (BV)</option>
                                <option value="LR">英国劳氏船级社 (LR)</option>
                                <option value="NK">日本船级社 (NK)</option>
                                <option value="RINA">意大利船级社 (RINA)</option>
                                <option value="RS">俄罗斯船级社 (RS)</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>

                        <!-- 状态字段 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                            <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="pending">待处理</option>
                                <option value="processing">处理中</option>
                                <option value="completed">已完成</option>
                                <option value="rejected">已驳回</option>
                            </select>
                        </div>
                    </div>

                    <!-- 产品规格 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">型号</label>
                            <input 
                                type="text" 
                                id="model"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入型号"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">功率</label>
                            <input 
                                type="text" 
                                id="power"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入功率"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">编号</label>
                            <input 
                                type="text" 
                                id="product-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入编号"
                            >
                        </div>
                    </div>

                    <!-- 价格信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                数量 <span class="required-mark">*</span>
                            </label>
                            <input 
                                type="number" 
                                id="quantity"
                                min="1"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入数量"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">价格计算标准</label>
                            <input 
                                type="text" 
                                id="price-standard"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入价格计算标准"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">单价</label>
                            <input 
                                type="number" 
                                id="unit-price"
                                min="0"
                                step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入单价"
                            >
                        </div>
                    </div>

                    <!-- 合计金额 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">合计金额</label>
                        <input 
                            type="number" 
                            id="total-amount"
                            min="0"
                            step="0.01"
                            readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"
                            placeholder="自动计算"
                        >
                        <div class="flex items-center mt-2">
                            <input 
                                type="checkbox" 
                                id="auto-calculate" 
                                checked
                                class="mr-2"
                            >
                            <label for="auto-calculate" class="text-sm text-gray-600">根据数量和单价自动计算</label>
                        </div>
                    </div>

                    <!-- 备注 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                        <textarea 
                            id="remarks"
                            rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                            placeholder="输入备注信息"
                        ></textarea>
                    </div>

                    <!-- 证书文件上传 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            证书文件 <span class="text-blue-500">(支持PDF、图片等格式)</span>
                        </label>
                        <div 
                            id="file-drop-area" 
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer"
                        >
                            <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">拖放证书文件到此处或点击上传</p>
                            <p class="text-sm text-gray-500 mb-4">支持PDF、JPG、PNG文件，单个文件不超过10MB</p>
                            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                <i class="fa fa-upload mr-2"></i>选择文件
                            </button>
                            <input type="file" id="certificate-files" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        </div>
                        <div id="file-list" class="mt-3 space-y-2"></div>
                    </div>
                </form>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="cancel-certificate" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="save-certificate" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                    <i class="fa fa-save mr-2"></i>保存证书
                </button>
            </div>
        </div>
    </div>

    <!-- 证书详情模态框 -->
    <div id="certificate-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">证书详情</h3>
                <button id="close-detail-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="certificate-detail-content">
                    <!-- 证书详情内容将在这里动态生成 -->
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="close-detail-btn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 状态处理模态框 -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">更新证书状态</h3>
                <button id="close-status-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择状态</label>
                    <select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="completed">已完成</option>
                        <option value="rejected">已驳回</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">处理说明</label>
                    <textarea 
                        id="status-remarks"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="请输入状态变更说明（可选）"
                    ></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="cancel-status" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="save-status" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    保存状态
                </button>
            </div>
        </div>
    </div>

    <script>
        // API基础地址 - 替换为你的服务器地址
        const API_BASE_URL = 'http://localhost:3001/api';

        // 用户认证系统
        const AuthSystem = {
            currentUser: null,
            token: null,

            async login(username, password) {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || '登录失败');
                    }

                    const data = await response.json();
                    this.currentUser = data.user;
                    this.token = data.token;
                    this.saveSession();
                    return data.user;
                } catch (error) {
                    console.error('登录错误:', error);
                    throw error;
                }
            },

            logout() {
                this.currentUser = null;
                this.token = null;
                this.clearSession();
                this.showLoginPage();
            },

            saveSession() {
                if (this.currentUser && this.token) {
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    localStorage.setItem('authToken', this.token);
                }
            },

            restoreSession() {
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    const savedToken = localStorage.getItem('authToken');
                    if (savedUser && savedToken) {
                        this.currentUser = JSON.parse(savedUser);
                        this.token = savedToken;
                        return true;
                    }
                } catch (e) {
                    console.error('恢复会话失败:', e);
                    this.clearSession();
                }
                return false;
            },

            clearSession() {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
            },

            showLoginPage() {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('main-system').classList.add('hidden');
            },

            showMainSystem() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                this.updateUserInterface();
            },

            updateUserInterface() {
                if (this.currentUser) {
                    document.getElementById('user-name').textContent = this.currentUser.name;
                    document.getElementById('user-role').textContent = this.currentUser.role === 'admin' ? '管理员' : '业务用户';
                    document.getElementById('user-avatar').textContent = this.currentUser.avatar || this.currentUser.name.charAt(0);
                }
            }
        };

        // 证书数据管理
        const CertificateManager = {
            async getAll() {
                try {
                    const response = await fetch(`${API_BASE_URL}/certificates`, {
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('获取证书列表失败');
                    const certificates = await response.json();
                    return certificates.sort((a, b) => new Date(b.applicationTime) - new Date(a.applicationTime));
                } catch (error) {
                    console.error('获取证书错误:', error);
                    return [];
                }
            },

            async getById(id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/certificates/${id}`, {
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('获取证书详情失败');
                    return await response.json();
                } catch (error) {
                    console.error('获取证书详情错误:', error);
                    return null;
                }
            },

            async search(query) {
                const allCertificates = await this.getAll();
                if (!query) return allCertificates;
                
                const lowerQuery = query.toLowerCase();
                return allCertificates.filter(cert => 
                    cert.certificateNumber.toLowerCase().includes(lowerQuery) ||
                    cert.productName.toLowerCase().includes(lowerQuery) ||
                    cert.customerName.toLowerCase().includes(lowerQuery) ||
                    (cert.planNumber && cert.planNumber.toLowerCase().includes(lowerQuery)) ||
                    (cert.contractNumber && cert.contractNumber.toLowerCase().includes(lowerQuery)) ||
                    (cert.model && cert.model.toLowerCase().includes(lowerQuery)) ||
                    (cert.classificationSociety && cert.classificationSociety.toLowerCase().includes(lowerQuery))
                );
            },

            async certificateNumberExists(number, excludeId = null) {
                try {
                    const allCertificates = await this.getAll();
                    return allCertificates.some(cert => 
                        cert.certificateNumber === number && cert._id !== excludeId
                    );
                } catch (error) {
                    console.error('验证证书编号错误:', error);
                    return false;
                }
            },

            async add(certificate) {
                try {
                    const response = await fetch(`${API_BASE_URL}/certificates`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AuthSystem.token}`
                        },
                        body: JSON.stringify(certificate)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || '创建证书失败');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('创建证书错误:', error);
                    throw error;
                }
            },

            async updateStatus(id, newStatus, remarks = '') {
                try {
                    const response = await fetch(`${API_BASE_URL}/certificates/${id}/status`, {
                        method: 'PATCH',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AuthSystem.token}`
                        },
                        body: JSON.stringify({ 
                            newStatus, 
                            remarks,
                            changedBy: AuthSystem.currentUser.name
                        })
                    });
                    
                    if (!response.ok) throw new Error('更新证书状态失败');
                    return true;
                } catch (error) {
                    console.error('更新证书状态错误:', error);
                    return false;
                }
            },

            async delete(id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/certificates/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('删除证书失败');
                    return true;
                } catch (error) {
                    console.error('删除证书错误:', error);
                    return false;
                }
            },

            async getClassificationSocietyStats() {
                try {
                    const response = await fetch(`${API_BASE_URL}/statistics/societies`, {
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('获取船级社统计失败');
                    return await response.json();
                } catch (error) {
                    console.error('获取船级社统计错误:', error);
                    return [];
                }
            },

            async getMonthlyStats() {
                try {
                    const response = await fetch(`${API_BASE_URL}/statistics/monthly`, {
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('获取月度统计失败');
                    return await response.json();
                } catch (error) {
                    console.error('获取月度统计错误:', error);
                    return [];
                }
            }
        };

        // 文件管理
        const FileManager = {
            async addFiles(certificateId, files) {
                try {
                    const formData = new FormData();
                    formData.append('certificateId', certificateId);
                    formData.append('uploadedBy', AuthSystem.currentUser.name);
                    
                    Array.from(files).forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`${API_BASE_URL}/files`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${AuthSystem.token}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || '文件上传失败');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('文件上传错误:', error);
                    throw error;
                }
            },

            async getFilesByCertificate(certificateId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/files/${certificateId}`, {
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('获取文件列表失败');
                    return await response.json();
                } catch (error) {
                    console.error('获取文件列表错误:', error);
                    return [];
                }
            },

            async downloadFile(fileId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/files/download/${fileId}`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${AuthSystem.token}` }
                    });
                    
                    if (!response.ok) throw new Error('文件下载失败');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // 从响应头获取文件名
                    const contentDisposition = response.headers.get('content-disposition');
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match && match[1]) {
                            a.download = match[1];
                        }
                    }
                    
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    return true;
                } catch (error) {
                    console.error('文件下载错误:', error);
                    return false;
                }
            }
        };

        // 统计分析管理
        const StatisticsManager = {
            async generateSocietyStatsChart() {
                const stats = await CertificateManager.getClassificationSocietyStats();
                
                if (stats.length === 0) {
                    return '<div class="text-center py-8 text-gray-500">暂无数据</div>';
                }

                let chartHtml = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="chart-container p-6 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-4">各船级社证书数量</h4>
                            <div class="space-y-3">
                `;

                const totalCertificates = stats.reduce((sum, item) => sum + item.count, 0);
                
                stats.forEach(item => {
                    const society = item._id || '其他';
                    const percentage = totalCertificates > 0 ? (item.count / totalCertificates * 100).toFixed(1) : 0;
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">${society}</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">${item.count} 张</span>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                            </div>
                        </div>
                        
                        <div class="chart-container p-6 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-4">各船级社费用统计</h4>
                            <div class="space-y-3">
                `;

                stats.forEach(item => {
                    const society = item._id || '其他';
                    const averageAmount = item.count > 0 ? item.totalAmount / item.count : 0;
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">${society}</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium text-green-600">¥${item.totalAmount.toFixed(2)}</span>
                                <span class="text-xs text-gray-500">均: ¥${averageAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                            </div>
                        </div>
                    </div>
                `;

                return chartHtml;
            },

            async generateMonthlyStatsChart() {
                const monthlyStats = await CertificateManager.getMonthlyStats();
                
                if (monthlyStats.length === 0) {
                    return '<div class="text-center py-8 text-gray-500">暂无月度数据</div>';
                }

                let chartHtml = `
                    <div class="chart-container p-6 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-4">月度费用趋势</h4>
                        <div class="space-y-4">
                `;

                const maxAmount = Math.max(...monthlyStats.map(stat => stat.totalAmount));
                
                monthlyStats.forEach(stat => {
                    const percentage = maxAmount > 0 ? (stat.totalAmount / maxAmount * 100).toFixed(1) : 0;
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700 w-20">${stat._id.year}年${stat._id.month}月</span>
                            <div class="flex-1 mx-4">
                                <div class="bg-gray-200 rounded-full h-3">
                                    <div class="bg-green-600 h-3 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="text-right w-32">
                                <div class="text-sm font-medium text-gray-900">¥${stat.totalAmount.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">${stat.count} 张证书</div>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                        </div>
                    </div>
                `;

                return chartHtml;
            },

            async generateSummaryStats() {
                const stats = await CertificateManager.getClassificationSocietyStats();
                const totalAmount = stats.reduce((sum, item) => sum + item.totalAmount, 0);
                const totalCertificates = stats.reduce((sum, item) => sum + item.count, 0);
                const averageAmount = totalCertificates > 0 ? totalAmount / totalCertificates : 0;

                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">总证书数量</p>
                                    <p class="text-2xl font-bold">${totalCertificates}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-file-text text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">总费用金额</p>
                                    <p class="text-2xl font-bold">¥${totalAmount.toFixed(2)}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-money text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">平均费用</p>
                                    <p class="text-2xl font-bold">¥${averageAmount.toFixed(2)}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-bar-chart text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // 系统状态管理
        const SystemState = {
            sidebarCollapsed: false,
            currentPage: 'certificate-list',
            currentFiles: [],
            searchQuery: '',
            currentCertificateId: null,

            async init() {
                // 尝试恢复会话
                if (AuthSystem.restoreSession()) {
                    AuthSystem.showMainSystem();
                    await this.loadPage('certificate-list');
                } else {
                    AuthSystem.showLoginPage();
                }
                
                this.setupEventListeners();
            },

            setupEventListeners() {
                // 登录表单
                document.getElementById('login-form').addEventListener('submit', this.handleLogin.bind(this));
                document.getElementById('toggle-password').addEventListener('click', this.togglePasswordVisibility);
                document.getElementById('logout-btn').addEventListener('click', () => {
                    AuthSystem.logout();
                });

                // 侧边栏导航
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        await this.loadPage(page);
                    });
                });

                // 证书表单事件
                document.getElementById('close-certificate-modal').addEventListener('click', () => {
                    this.hideAddCertificateModal();
                });

                document.getElementById('cancel-certificate').addEventListener('click', () => {
                    this.hideAddCertificateModal();
                });

                document.getElementById('save-certificate').addEventListener('click', () => {
                    this.saveCertificate();
                });

                // 自动计算金额
                document.getElementById('quantity').addEventListener('input', () => {
                    this.calculateTotalAmount();
                });

                document.getElementById('unit-price').addEventListener('input', () => {
                    this.calculateTotalAmount();
                });

                document.getElementById('auto-calculate').addEventListener('change', () => {
                    this.calculateTotalAmount();
                });

                // 证书编号验证
                document.getElementById('certificate-number').addEventListener('blur', async () => {
                    await this.validateCertificateNumber();
                });

                // 文件上传事件
                this.setupFileUpload();

                // 证书详情模态框
                document.getElementById('close-detail-modal').addEventListener('click', () => {
                    this.hideCertificateDetailModal();
                });

                document.getElementById('close-detail-btn').addEventListener('click', () => {
                    this.hideCertificateDetailModal();
                });

                // 状态处理模态框
                document.getElementById('close-status-modal').addEventListener('click', () => {
                    this.hideStatusModal();
                });

                document.getElementById('cancel-status').addEventListener('click', () => {
                    this.hideStatusModal();
                });

                document.getElementById('save-status').addEventListener('click', () => {
                    this.saveStatus();
                });
            },

            setupFileUpload() {
                const dropArea = document.getElementById('file-drop-area');
                const fileInput = document.getElementById('certificate-files');

                // 点击选择文件
                dropArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // 文件选择变化
                fileInput.addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });

                // 拖放功能
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.add('file-drag-over');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.remove('file-drag-over');
                    }, false);
                });

                dropArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    this.handleFileUpload(files);
                });
            },

            async handleLogin(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('login-button');
                const loginSpinner = document.getElementById('login-spinner');
                const loginError = document.getElementById('login-error');

                loginButton.disabled = true;
                loginSpinner.classList.remove('hidden');
                loginError.classList.add('hidden');

                try {
                    await AuthSystem.login(username, password);
                    AuthSystem.showMainSystem();
                    await this.loadPage('certificate-list');
                } catch (error) {
                    loginError.classList.remove('hidden');
                    loginError.querySelector('span').textContent = error.message;
                } finally {
                    loginButton.disabled = false;
                    loginSpinner.classList.add('hidden');
                }
            },

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('password');
                const toggleButton = document.getElementById('toggle-password');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleButton.innerHTML = '<i class="fa fa-eye"></i>';
                } else {
                    passwordInput.type = 'password';
                    toggleButton.innerHTML = '<i class="fa fa-eye-slash"></i>';
                }
            },

            toggleSidebar() {
                this.sidebarCollapsed = !this.sidebarCollapsed;
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');

                if (this.sidebarCollapsed) {
                    sidebar.classList.remove('w-64');
                    sidebar.classList.add('w-16');
                    mainContent.classList.add('ml-16');
                    mainContent.classList.remove('ml-64');
                } else {
                    sidebar.classList.remove('w-16');
                    sidebar.classList.add('w-64');
                    mainContent.classList.remove('ml-16');
                    mainContent.classList.add('ml-64');
                }
            },

            async loadPage(page) {
                this.currentPage = page;
                
                // 更新导航状态
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active', 'bg-blue-50', 'text-blue-600');
                    if (item.getAttribute('data-page') === page) {
                        item.classList.add('active', 'bg-blue-50', 'text-blue-600');
                    }
                });

                // 加载页面内容
                const content = await this.generatePageContent(page);
                document.getElementById('page-content').innerHTML = content;
                document.getElementById('page-content').classList.add('fade-in');

                setTimeout(() => {
                    document.getElementById('page-content').classList.remove('fade-in');
                }, 500);
            },

            async generatePageContent(page) {
                switch(page) {
                    case 'certificate-list':
                        return await this.generateCertificateList();
                    case 'add-certificate':
                        this.showAddCertificateModal();
                        return await this.generateCertificateList();
                    case 'statistics':
                        return await this.generateStatisticsPage();
                    default:
                        return await this.generateCertificateList();
                }
            },

            async generateStatisticsPage() {
                return `
                    <div class="max-w-7xl mx-auto">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">船级社费用统计</h2>
                                <p class="text-gray-600 mt-1">查看各船级社的费用分布和统计信息</p>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 lg:mt-0">
                                <button onclick="SystemState.exportStatistics()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                    <i class="fa fa-download mr-2"></i>导出统计
                                </button>
                            </div>
                        </div>

                        ${await StatisticsManager.generateSummaryStats()}
                        ${await StatisticsManager.generateSocietyStatsChart()}
                        ${await StatisticsManager.generateMonthlyStatsChart()}
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">详细费用明细</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">船级社</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书数量</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总费用</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均费用</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${await this.generateStatisticsTable()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            async generateStatisticsTable() {
                const stats = await CertificateManager.getClassificationSocietyStats();
                const totalAmount = stats.reduce((sum, item) => sum + item.totalAmount, 0);
                
                if (stats.length === 0) {
                    return `
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                <i class="fa fa-bar-chart text-3xl mb-3 block"></i>
                                暂无统计数据
                            </td>
                        </tr>
                    `;
                }

                return stats.map(item => {
                    const society = item._id || '其他';
                    const percentage = totalAmount > 0 ? (item.totalAmount / totalAmount * 100).toFixed(1) : 0;
                    const averageAmount = item.count > 0 ? item.totalAmount / item.count : 0;
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${society}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${item.count} 张</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-green-600">¥${item.totalAmount.toFixed(2)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">¥${averageAmount.toFixed(2)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${percentage}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            exportStatistics() {
                // 导出功能实现
                alert('统计报告导出功能已触发');
            },

            async generateCertificateList() {
                const certificates = this.searchQuery ? 
                    await CertificateManager.search(this.searchQuery) : 
                    await CertificateManager.getAll();
                    
                const canAddCertificate = AuthSystem.currentUser.role === 'admin' || AuthSystem.currentUser.role === 'user';

                // 更新证书数量
                document.getElementById('cert-count').textContent = certificates.length;

                return `
                    <div class="max-w-7xl mx-auto">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">证书列表</h2>
                                <p class="text-gray-600 mt-1">管理和查看所有证书登记信息</p>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 lg:mt-0">
                                <div class="relative">
                                    <input type="text" id="search-input" placeholder="搜索证书编号、产品名称、客户名称..." 
                                        value="${this.searchQuery}"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full lg:w-80">
                                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                                ${canAddCertificate ? `
                                <button onclick="SystemState.showAddCertificateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                    <i class="fa fa-plus mr-2"></i>新增证书
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">总证书数</p>
                                        <p class="text-2xl font-bold text-gray-800">${certificates.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-file-text text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">待处理</p>
                                        <p class="text-2xl font-bold text-orange-600">${certificates.filter(c => c.status === 'pending').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-clock-o text-orange-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">已完成</p>
                                        <p class="text-2xl font-bold text-green-600">${certificates.filter(c => c.status === 'completed').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-check text-green-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">有附件</p>
                                        <p class="text-2xl font-bold text-purple-600">${certificates.filter(async c => (await FileManager.getFilesByCertificate(c._id)).length > 0).length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-paperclip text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${this.searchQuery ? `
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fa fa-info-circle text-blue-500 mr-2"></i>
                                    <span class="text-blue-700">搜索关键词: "${this.searchQuery}"，找到 ${certificates.length} 条记录</span>
                                </div>
                                <button onclick="SystemState.clearSearch()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fa fa-times mr-1"></i>清除搜索
                                </button>
                            </div>
                        </div>
                        ` : ''}

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">船级社</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书编号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">产品名称</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户名称</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">产品型号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">编号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${certificates.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                                <i class="fa fa-folder-open text-3xl mb-3 block"></i>
                                                ${this.searchQuery ? '没有找到匹配的证书' : '暂无证书数据'}
                                                ${canAddCertificate && !this.searchQuery ? '<br><button onclick="SystemState.showAddCertificateModal()" class="text-blue-600 hover:text-blue-800 mt-2">点击添加第一个证书</button>' : ''}
                                            </td>
                                        </tr>
                                        ` : certificates.map(cert => {
                                            const statusClass = this.getStatusClass(cert.status);
                                            const statusText = this.getStatusText(cert.status);
                                            return `
                                        <tr class="table-row-hover transition-all">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${new Date(cert.applicationTime).toLocaleString()}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900">${cert.classificationSociety || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900">${cert.certificateNumber}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900">${cert.productName}</div>
                                                ${cert.model ? `<div class="text-xs text-gray-500">型号: ${cert.model}</div>` : ''}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900">${cert.customerName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.model || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.productNumber || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.quantity}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                                    ${statusText}
                                                </span>
                                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800 file-count-${cert._id}">
                                                    <i class="fa fa-paperclip mr-1"></i>加载中...
                                                </span>
                                                <script>
                                                    (async () => {
                                                        const files = await FileManager.getFilesByCertificate('${cert._id}');
                                                        const el = document.querySelector('.file-count-${cert._id}');
                                                        if (el) {
                                                            if (files.length > 0) {
                                                                el.innerHTML = '<i class="fa fa-paperclip mr-1"></i>' + files.length;
                                                            } else {
                                                                el.style.display = 'none';
                                                            }
                                                        }
                                                    })();
                                                <\/script>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <div class="flex justify-end space-x-2">
                                                    <button class="text-blue-600 hover:text-blue-800" onclick="SystemState.showCertificateDetail('${cert._id}')" title="查看详情">
                                                        <i class="fa fa-eye"></i>
                                                    </button>
                                                    ${AuthSystem.currentUser.role === 'admin' ? `
                                                    <button class="text-purple-600 hover:text-purple-800" onclick="SystemState.showStatusModal('${cert._id}')" title="更新状态">
                                                        <i class="fa fa-refresh"></i>
                                                    </button>
                                                    <button class="text-red-600 hover:text-red-800" onclick="SystemState.deleteCertificate('${cert._id}')" title="删除证书">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <script>
                        // 搜索功能
                        document.getElementById('search-input').addEventListener('input', function(e) {
                            const query = e.target.value.trim();
                            SystemState.searchQuery = query;
                            SystemState.loadPage('certificate-list');
                        });
                    <\/script>
                `;
            },

            getStatusClass(status) {
                switch(status) {
                    case 'pending': return 'status-pending';
                    case 'processing': return 'status-processing';
                    case 'completed': return 'status-completed';
                    case 'rejected': return 'status-rejected';
                    default: return 'status-pending';
                }
            },

            getStatusText(status) {
                switch(status) {
                    case 'pending': return '待处理';
                    case 'processing': return '处理中';
                    case 'completed': return '已完成';
                    case 'rejected': return '已驳回';
                    default: return '待处理';
                }
            },

            showAddCertificateModal() {
                const modal = document.getElementById('add-certificate-modal');
                const form = document.getElementById('certificate-form');
                
                form.reset();
                this.currentFiles = [];
                this.updateFileList();
                
                // 设置默认时间
                const now = new Date();
                const localDateTime = now.toISOString().slice(0, 16);
                document.getElementById('application-time').value = localDateTime;
                
                modal.classList.remove('hidden');
            },

            hideAddCertificateModal() {
                const modal = document.getElementById('add-certificate-modal');
                modal.classList.add('hidden');
            },

            async showCertificateDetail(id) {
                const certificate = await CertificateManager.getById(id);
                if (!certificate) return;

                const files = await FileManager.getFilesByCertificate(id);
                const modal = document.getElementById('certificate-detail-modal');
                const content = document.getElementById('certificate-detail-content');

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">基本信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">申请时间:</span>
                                        <span class="font-medium">${new Date(certificate.applicationTime).toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">船级社:</span>
                                        <span class="font-medium">${certificate.classificationSociety || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">证书编号:</span>
                                        <span class="font-medium">${certificate.certificateNumber}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">产品名称:</span>
                                        <span class="font-medium">${certificate.productName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">客户名称:</span>
                                        <span class="font-medium">${certificate.customerName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">产品型号:</span>
                                        <span class="font-medium">${certificate.model || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">编号:</span>
                                        <span class="font-medium">${certificate.productNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">数量:</span>
                                        <span class="font-medium">${certificate.quantity}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">状态:</span>
                                        <span class="font-medium ${this.getStatusClass(certificate.status)} px-2 py-1 rounded-full text-xs">${this.getStatusText(certificate.status)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">产品规格</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">型号:</span>
                                        <span class="font-medium">${certificate.model || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">功率:</span>
                                        <span class="font-medium">${certificate.power || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">编号:</span>
                                        <span class="font-medium">${certificate.productNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">计划号:</span>
                                        <span class="font-medium">${certificate.planNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">合同号:</span>
                                        <span class="font-medium">${certificate.contractNumber || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">价格信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">数量:</span>
                                        <span class="font-medium">${certificate.quantity}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">价格计算标准:</span>
                                        <span class="font-medium">${certificate.priceStandard || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">单价:</span>
                                        <span class="font-medium">${certificate.unitPrice ? '¥' + certificate.unitPrice.toFixed(2) : '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">合计金额:</span>
                                        <span class="font-medium text-blue-600">${certificate.totalAmount ? '¥' + certificate.totalAmount.toFixed(2) : '-'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">系统信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">创建人:</span>
                                        <span class="font-medium">${certificate.createdBy}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">创建时间:</span>
                                        <span class="font-medium">${new Date(certificate.createdAt).toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">附件数量:</span>
                                        <span class="font-medium">${files.length} 个文件</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${certificate.remarks ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">备注</h4>
                            <p class="text-sm text-gray-700">${certificate.remarks}</p>
                        </div>
                        ` : ''}
                        
                        ${files.length > 0 ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">附件文件</h4>
                            <div class="space-y-2">
                                ${files.map(file => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <div class="flex items-center">
                                        <i class="fa ${this.getFileIcon(file.type)} text-blue-600 mr-3"></i>
                                        <div>
                                            <div class="text-sm font-medium">${file.name}</div>
                                            <div class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB • ${new Date(file.uploadTime).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-500">上传者: ${file.uploadedBy}</span>
                                        <button class="text-green-600 hover:text-green-800 ml-2" onclick="FileManager.downloadFile('${file._id}')" title="下载文件">
                                            <i class="fa fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${certificate.statusHistory && certificate.statusHistory.length > 0 ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">状态历史</h4>
                            <div class="space-y-3">
                                ${certificate.statusHistory.map(history => `
                                <div class="flex items-start space-x-3 p-2 bg-white rounded border">
                                    <div class="w-2 h-2 mt-2 rounded-full ${this.getStatusClass(history.status)}"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <span class="font-medium ${this.getStatusClass(history.status)} px-2 py-1 rounded-full text-xs">${this.getStatusText(history.status)}</span>
                                            <span class="text-xs text-gray-500">${new Date(history.changedAt).toLocaleString()}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">操作人: ${history.changedBy}</div>
                                        ${history.remarks ? `<div class="text-sm text-gray-700 mt-1">说明: ${history.remarks}</div>` : ''}
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.classList.remove('hidden');
            },

            hideCertificateDetailModal() {
                const modal = document.getElementById('certificate-detail-modal');
                modal.classList.add('hidden');
            },

            showStatusModal(certificateId) {
                this.currentCertificateId = certificateId;
                const modal = document.getElementById('status-modal');
                modal.classList.remove('hidden');
            },

            hideStatusModal() {
                const modal = document.getElementById('status-modal');
                modal.classList.add('hidden');
                this.currentCertificateId = null;
            },

            async saveStatus() {
                if (!this.currentCertificateId) return;

                const newStatus = document.getElementById('status-select').value;
                const remarks = document.getElementById('status-remarks').value;

                if (await CertificateManager.updateStatus(this.currentCertificateId, newStatus, remarks)) {
                    alert('状态更新成功！');
                    this.hideStatusModal();
                    await this.loadPage('certificate-list');
                } else {
                    alert('状态更新失败！');
                }
            },

            async deleteCertificate(id) {
                if (confirm('确定要删除这个证书吗？此操作不可撤销。')) {
                    if (await CertificateManager.delete(id)) {
                        await this.loadPage('certificate-list');
                        alert('证书删除成功！');
                    } else {
                        alert('证书删除失败！');
                    }
                }
            },

            async validateCertificateNumber() {
                const numberInput = document.getElementById('certificate-number');
                const errorDiv = document.getElementById('certificate-number-error');
                const number = numberInput.value.trim();

                if (number && await CertificateManager.certificateNumberExists(number)) {
                    errorDiv.classList.remove('hidden');
                    numberInput.classList.add('form-error');
                    return false;
                } else {
                    errorDiv.classList.add('hidden');
                    numberInput.classList.remove('form-error');
                    return true;
                }
            },

            calculateTotalAmount() {
                const autoCalculate = document.getElementById('auto-calculate').checked;
                const totalAmountInput = document.getElementById('total-amount');

                if (autoCalculate) {
                    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                    const unitPrice = parseFloat(document.getElementById('unit-price').value) || 0;
                    const totalAmount = quantity * unitPrice;
                    totalAmountInput.value = totalAmount.toFixed(2);
                }
            },

            handleFileUpload(files) {
                Array.from(files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`文件 ${file.name} 超过10MB限制`);
                        return;
                    }

                    // 检查文件类型
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                    if (!allowedTypes.includes(file.type)) {
                        alert(`文件 ${file.name} 格式不支持`);
                        return;
                    }

                    this.currentFiles.push(file);
                });

                this.updateFileList();
            },

            updateFileList() {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                this.currentFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fa ${this.getFileIcon(file.type)} text-blue-600 mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-gray-800">${file.name}</div>
                                <div class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                            </div>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="SystemState.removeFile(${index})">
                            <i class="fa fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
            },

            getFileIcon(fileType) {
                if (fileType === 'application/pdf') return 'fa-file-pdf-o';
                if (fileType.startsWith('image/')) return 'fa-file-image-o';
                if (fileType.includes('word')) return 'fa-file-word-o';
                return 'fa-file-o';
            },

            removeFile(index) {
                this.currentFiles.splice(index, 1);
                this.updateFileList();
            },

            async saveCertificate() {
                if (!this.validateCertificateForm()) {
                    alert('请填写所有必填字段');
                    return;
                }

                if (!await this.validateCertificateNumber()) {
                    alert('证书编号已存在');
                    return;
                }

                const certificateData = {
                    certificateNumber: document.getElementById('certificate-number').value.trim(),
                    applicationTime: document.getElementById('application-time').value,
                    productName: document.getElementById('product-name').value.trim(),
                    customerName: document.getElementById('customer-name').value.trim(),
                    planNumber: document.getElementById('plan-number').value.trim(),
                    contractNumber: document.getElementById('contract-number').value.trim(),
                    classificationSociety: document.getElementById('classification-society').value,
                    model: document.getElementById('model').value.trim(),
                    power: document.getElementById('power').value.trim(),
                    productNumber: document.getElementById('product-number').value.trim(),
                    quantity: parseInt(document.getElementById('quantity').value),
                    priceStandard: document.getElementById('price-standard').value.trim(),
                    unitPrice: parseFloat(document.getElementById('unit-price').value) || 0,
                    totalAmount: parseFloat(document.getElementById('total-amount').value) || 0,
                    remarks: document.getElementById('remarks').value.trim(),
                    status: document.getElementById('status').value,
                    createdBy: AuthSystem.currentUser.name
                };

                try {
                    const saveBtn = document.getElementById('save-certificate');
                    saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>保存中...';
                    saveBtn.disabled = true;

                    // 保存证书
                    const newCertificate = await CertificateManager.add(certificateData);

                    // 保存文件
                    if (this.currentFiles.length > 0) {
                        await FileManager.addFiles(newCertificate._id, this.currentFiles);
                    }

                    saveBtn.innerHTML = '<i class="fa fa-save mr-2"></i>保存证书';
                    saveBtn.disabled = false;

                    alert('证书保存成功！');
                    this.hideAddCertificateModal();
                    await this.loadPage('certificate-list');

                } catch (error) {
                    alert('证书保存失败: ' + error.message);
                    console.error('保存证书失败:', error);
                    saveBtn.innerHTML = '<i class="fa fa-save mr-2"></i>保存证书';
                    saveBtn.disabled = false;
                }
            },

            validateCertificateForm() {
                let isValid = true;
                const requiredFields = [
                    'certificate-number',
                    'application-time',
                    'product-name',
                    'customer-name',
                    'quantity'
                ];

                // 清除之前的错误样式
                requiredFields.forEach(field => {
                    document.getElementById(field).classList.remove('form-error');
                });

                // 验证必填字段
                requiredFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (!element.value.trim()) {
                        element.classList.add('form-error');
                        isValid = false;
                    }
                });

                // 验证数量是否有效
                const quantity = document.getElementById('quantity').value;
                if (quantity <= 0) {
                    document.getElementById('quantity').classList.add('form-error');
                    isValid = false;
                }

                return isValid;
            },

            clearSearch() {
                this.searchQuery = '';
                document.getElementById('search-input').value = '';
                this.loadPage('certificate-list');
            }
        };

        // 初始化系统
        document.addEventListener('DOMContentLoaded', () => {
            // 暴露给全局，以便HTML中的onclick调用
            window.SystemState = SystemState;
            window.FileManager = FileManager;
            SystemState.init();
        });
    </script>
</body>
</html>
    
