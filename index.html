<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>证书登记系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }
        .content-transition {
            transition: margin-left 0.3s ease-in-out;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
        }
        .login-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-row-hover:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateY(-1px);
        }
        .file-drag-over {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        .certificate-detail {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .status-pending { background-color: #fef3c7; color: #d97706; }
        .status-processing { background-color: #dbeafe; color: #1d4ed8; }
        .status-completed { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; }
        .chart-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 登录页面 -->
    <div id="login-page" class="login-bg flex items-center justify-center min-h-screen p-4">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-500 hover:shadow-3xl">
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class="fa fa-certificate text-white text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">证书登记系统</h1>
                        <p class="text-gray-600 mt-2">请登录您的账户</p>
                    </div>

                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa fa-user text-gray-400"></i>
                                </div>
                                <input 
                                    type="text" 
                                    id="username" 
                                    name="username"
                                    required
                                    class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50"
                                    placeholder="请输入用户名"
                                >
                            </div>
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa fa-lock text-gray-400"></i>
                                </div>
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password"
                                    required
                                    class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50"
                                    placeholder="请输入密码"
                                >
                                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors">
                                    <i class="fa fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>

                        <button 
                            type="submit" 
                            id="login-button"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg flex items-center justify-center"
                        >
                            <i class="fa fa-sign-in mr-2"></i>登录
                            <i class="fa fa-spinner fa-spin ml-2 hidden" id="login-spinner"></i>
                        </button>
                    </form>

                    <div id="login-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden">
                        <div class="flex items-center">
                            <i class="fa fa-exclamation-circle text-red-500 mr-2"></i>
                            <span class="text-sm text-red-700">用户名或密码错误</span>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-sm font-medium text-blue-800 mb-2">测试账号</h3>
                        <div class="text-xs text-blue-600 space-y-1">
                            <div>管理员账号: admin / admin123</div>
                            <div>业务用户账号: user / user123</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主系统界面 -->
    <div id="main-system" class="hidden">
        <!-- 顶部导航栏 -->
        <header class="glass-effect shadow-sm border-b border-gray-200 sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-100 transition-all duration-200 transform hover:scale-105 group">
                        <i class="fa fa-bars text-gray-600 group-hover:text-blue-600 transition-colors"></i>
                    </button>
                    
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-certificate text-blue-600 text-xl"></i>
                        <h1 class="text-lg font-semibold text-gray-800">证书登记系统</h1>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 text-sm">
                        <div id="user-avatar" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-medium text-sm">
                            用
                        </div>
                        <div class="text-right">
                            <div id="user-name" class="font-medium text-gray-800">用户</div>
                            <div id="user-role" class="text-xs text-gray-500">角色</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-all group">
                        <i class="fa fa-sign-out text-gray-600 group-hover:text-red-600"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- 侧边栏 -->
            <aside id="sidebar" class="sidebar-transition glass-effect h-[calc(100vh-64px)] shadow-sm border-r border-gray-200 overflow-y-auto hide-scrollbar sticky top-16 w-64">
                <nav class="p-4">
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">证书管理</h3>
                        <div class="space-y-1">
                            <a href="#" class="nav-item active flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="certificate-list">
                                <i class="fa fa-list-alt w-5 text-center mr-3 text-blue-600"></i>
                                <span class="font-medium">证书列表</span>
                                <span class="ml-auto bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full" id="cert-count">0</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="add-certificate">
                                <i class="fa fa-plus-circle w-5 text-center mr-3 text-gray-500 group-hover:text-blue-500"></i>
                                <span class="text-gray-700 group-hover:text-blue-600">新增证书</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">统计分析</h3>
                        <div class="space-y-1">
                            <a href="#" class="nav-item flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 group" data-page="statistics">
                                <i class="fa fa-bar-chart w-5 text-center mr-3 text-gray-500 group-hover:text-blue-500"></i>
                                <span class="text-gray-700 group-hover:text-blue-600">费用统计</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- 主内容区域 -->
            <main id="main-content" class="content-transition flex-1 min-h-[calc(100vh-64px)] p-6 ml-0">
                <div id="page-content" class="fade-in">
                    <!-- 动态内容 -->
                </div>
            </main>
        </div>
    </div>

    <!-- 新增证书模态框 -->
    <div id="add-certificate-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">新增证书</h3>
                <button id="close-certificate-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <form id="certificate-form" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                证书编号 <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="certificate-number"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入证书编号"
                            >
                            <div id="certificate-number-error" class="text-red-500 text-xs mt-1 hidden">
                                该证书编号已存在
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                申请时间 <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="datetime-local" 
                                id="application-time"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                产品名称 <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="product-name"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入产品名称"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                客户名称 <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="customer-name"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入客户名称"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">计划号</label>
                            <input 
                                type="text" 
                                id="plan-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入计划号"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">合同号</label>
                            <input 
                                type="text" 
                                id="contract-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入合同号"
                            >
                        </div>
                        
                        <!-- 新增船级社字段 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">船级社</label>
                            <select id="classification-society" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="">请选择船级社</option>
                                <option value="CCS">中国船级社 (CCS)</option>
                                <option value="DNV">DNV</option>
                                <option value="ABS">美国船级社 (ABS)</option>
                                <option value="BV">法国船级社 (BV)</option>
                                <option value="LR">英国劳氏船级社 (LR)</option>
                                <option value="NK">日本船级社 (NK)</option>
                                <option value="RINA">意大利船级社 (RINA)</option>
                                <option value="RS">俄罗斯船级社 (RS)</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>

                        <!-- 状态字段 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                            <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="pending">待处理</option>
                                <option value="processing">处理中</option>
                                <option value="completed">已完成</option>
                                <option value="rejected">已驳回</option>
                            </select>
                        </div>
                    </div>

                    <!-- 产品规格 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">型号</label>
                            <input 
                                type="text" 
                                id="model"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入型号"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">功率</label>
                            <input 
                                type="text" 
                                id="power"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入功率"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">编号</label>
                            <input 
                                type="text" 
                                id="product-number"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入编号"
                            >
                        </div>
                    </div>

                    <!-- 价格信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                数量 <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="number" 
                                id="quantity"
                                min="1"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入数量"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">价格计算标准</label>
                            <input 
                                type="text" 
                                id="price-standard"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入价格计算标准"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">单价</label>
                            <input 
                                type="number" 
                                id="unit-price"
                                min="0"
                                step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                placeholder="输入单价"
                            >
                        </div>
                    </div>

                    <!-- 合计金额 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">合计金额</label>
                        <input 
                            type="number" 
                            id="total-amount"
                            min="0"
                            step="0.01"
                            readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"
                            placeholder="自动计算"
                        >
                        <div class="flex items-center mt-2">
                            <input 
                                type="checkbox" 
                                id="auto-calculate" 
                                checked
                                class="mr-2"
                            >
                            <label for="auto-calculate" class="text-sm text-gray-600">根据数量和单价自动计算</label>
                        </div>
                    </div>

                    <!-- 备注 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                        <textarea 
                            id="remarks"
                            rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                            placeholder="输入备注信息"
                        ></textarea>
                    </div>

                    <!-- 证书文件上传 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            证书文件 <span class="text-blue-500">(支持PDF、图片等格式)</span>
                        </label>
                        <div 
                            id="file-drop-area" 
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer"
                        >
                            <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">拖放证书文件到此处或点击上传</p>
                            <p class="text-sm text-gray-500 mb-4">支持PDF、JPG、PNG文件，单个文件不超过10MB</p>
                            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                <i class="fa fa-upload mr-2"></i>选择文件
                            </button>
                            <input type="file" id="certificate-files" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        </div>
                        <div id="file-list" class="mt-3 space-y-2"></div>
                    </div>
                </form>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="cancel-certificate" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="save-certificate" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                    <i class="fa fa-save mr-2"></i>保存证书
                </button>
            </div>
        </div>
    </div>

    <!-- 证书详情模态框 -->
    <div id="certificate-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">证书详情</h3>
                <button id="close-detail-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="certificate-detail-content">
                    <!-- 证书详情内容将在这里动态生成 -->
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="close-detail-btn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 状态处理模态框 -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">更新证书状态</h3>
                <button id="close-status-modal" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择状态</label>
                    <select id="status-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="completed">已完成</option>
                        <option value="rejected">已驳回</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">处理说明</label>
                    <textarea 
                        id="status-remarks"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="请输入状态变更说明（可选）"
                    ></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button id="cancel-status" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="save-status" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    保存状态
                </button>
            </div>
        </div>
    </div>

    <script>
        // 用户认证系统
        const AuthSystem = {
            users: [
                {
                    id: 1,
                    username: 'admin',
                    password: 'admin123',
                    name: '系统管理员',
                    role: 'admin',
                    avatar: '管'
                },
                {
                    id: 2,
                    username: 'user',
                    password: 'user123',
                    name: '业务用户',
                    role: 'user',
                    avatar: '业'
                }
            ],

            currentUser: null,

            async login(username, password) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const user = this.users.find(u => 
                            u.username === username && u.password === password
                        );
                        
                        if (user) {
                            const { password: _, ...userWithoutPassword } = user;
                            this.currentUser = userWithoutPassword;
                            this.saveSession();
                            resolve(userWithoutPassword);
                        } else {
                            reject(new Error('用户名或密码错误'));
                        }
                    }, 500);
                });
            },

            logout() {
                this.currentUser = null;
                this.clearSession();
                this.showLoginPage();
            },

            saveSession() {
                if (this.currentUser) {
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
            },

            restoreSession() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    return true;
                }
                return false;
            },

            clearSession() {
                localStorage.removeItem('currentUser');
            },

            showLoginPage() {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('main-system').classList.add('hidden');
            },

            showMainSystem() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                this.updateUserInterface();
            },

            updateUserInterface() {
                if (this.currentUser) {
                    document.getElementById('user-name').textContent = this.currentUser.name;
                    document.getElementById('user-role').textContent = this.currentUser.role === 'admin' ? '管理员' : '业务用户';
                    document.getElementById('user-avatar').textContent = this.currentUser.avatar;
                }
            }
        };

        // 证书数据管理
        const CertificateManager = {
            certificates: JSON.parse(localStorage.getItem('certificates')) || [],
            nextId: parseInt(localStorage.getItem('nextCertificateId')) || 1,

            getAll() {
                return this.certificates.sort((a, b) => new Date(b.applicationTime) - new Date(a.applicationTime));
            },

            getById(id) {
                return this.certificates.find(cert => cert.id === id);
            },

            search(query) {
                if (!query) return this.getAll();
                
                const lowerQuery = query.toLowerCase();
                return this.certificates.filter(cert => 
                    cert.certificateNumber.toLowerCase().includes(lowerQuery) ||
                    cert.productName.toLowerCase().includes(lowerQuery) ||
                    cert.customerName.toLowerCase().includes(lowerQuery) ||
                    (cert.planNumber && cert.planNumber.toLowerCase().includes(lowerQuery)) ||
                    (cert.contractNumber && cert.contractNumber.toLowerCase().includes(lowerQuery)) ||
                    (cert.model && cert.model.toLowerCase().includes(lowerQuery)) ||
                    (cert.classificationSociety && cert.classificationSociety.toLowerCase().includes(lowerQuery))
                );
            },

            certificateNumberExists(number, excludeId = null) {
                return this.certificates.some(cert => 
                    cert.certificateNumber === number && cert.id !== excludeId
                );
            },

            add(certificate) {
                const newCertificate = {
                    id: this.nextId++,
                    ...certificate,
                    createdAt: new Date().toISOString(),
                    createdBy: AuthSystem.currentUser.name,
                    statusHistory: [{
                        status: certificate.status,
                        changedBy: AuthSystem.currentUser.name,
                        changedAt: new Date().toISOString(),
                        remarks: '初始状态'
                    }]
                };
                
                this.certificates.push(newCertificate);
                this.saveToStorage();
                return newCertificate;
            },

            updateStatus(id, newStatus, remarks = '') {
                const certificate = this.getById(id);
                if (certificate) {
                    certificate.status = newStatus;
                    certificate.statusHistory.push({
                        status: newStatus,
                        changedBy: AuthSystem.currentUser.name,
                        changedAt: new Date().toISOString(),
                        remarks: remarks
                    });
                    this.saveToStorage();
                    return true;
                }
                return false;
            },

            delete(id) {
                const index = this.certificates.findIndex(cert => cert.id === id);
                if (index !== -1) {
                    this.certificates.splice(index, 1);
                    this.saveToStorage();
                    return true;
                }
                return false;
            },

            // 获取船级社费用统计
            getClassificationSocietyStats() {
                const stats = {};
                const societies = ['CCS', 'DNV', 'ABS', 'BV', 'LR', 'NK', 'RINA', 'RS', 'BV', '其他'];
                
                // 初始化所有船级社
                societies.forEach(society => {
                    stats[society] = {
                        count: 0,
                        totalAmount: 0,
                        averageAmount: 0,
                        certificates: []
                    };
                });

                // 统计数据
                this.certificates.forEach(cert => {
                    const society = cert.classificationSociety || '其他';
                    if (stats[society]) {
                        stats[society].count++;
                        stats[society].totalAmount += cert.totalAmount || 0;
                        stats[society].certificates.push(cert);
                    }
                });

                // 计算平均值
                societies.forEach(society => {
                    if (stats[society].count > 0) {
                        stats[society].averageAmount = stats[society].totalAmount / stats[society].count;
                    }
                });

                return stats;
            },

            // 获取月度费用统计
            getMonthlyStats() {
                const monthlyStats = {};
                const currentYear = new Date().getFullYear();
                
                this.certificates.forEach(cert => {
                    const certDate = new Date(cert.applicationTime);
                    const year = certDate.getFullYear();
                    const month = certDate.getMonth() + 1;
                    
                    if (year === currentYear) {
                        const key = `${year}-${month.toString().padStart(2, '0')}`;
                        if (!monthlyStats[key]) {
                            monthlyStats[key] = {
                                month: `${year}年${month}月`,
                                count: 0,
                                totalAmount: 0
                            };
                        }
                        monthlyStats[key].count++;
                        monthlyStats[key].totalAmount += cert.totalAmount || 0;
                    }
                });

                return Object.values(monthlyStats).sort((a, b) => {
                    return a.month.localeCompare(b.month);
                });
            },

            saveToStorage() {
                localStorage.setItem('certificates', JSON.stringify(this.certificates));
                localStorage.setItem('nextCertificateId', this.nextId.toString());
            }
        };

        // 文件管理
        const FileManager = {
            files: JSON.parse(localStorage.getItem('certificateFiles')) || [],

            addFile(certificateId, file) {
                const fileData = {
                    id: Date.now(),
                    certificateId: certificateId,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadTime: new Date().toISOString(),
                    uploadedBy: AuthSystem.currentUser.name,
                    // 模拟文件内容（在实际应用中应该是真实的文件数据）
                    content: URL.createObjectURL(file)
                };
                
                this.files.push(fileData);
                this.saveToStorage();
                return fileData;
            },

            getFilesByCertificate(certificateId) {
                return this.files.filter(file => file.certificateId === certificateId);
            },

            getFileById(fileId) {
                return this.files.find(file => file.id === fileId);
            },

            deleteFile(fileId) {
                const index = this.files.findIndex(file => file.id === fileId);
                if (index !== -1) {
                    this.files.splice(index, 1);
                    this.saveToStorage();
                    return true;
                }
                return false;
            },

            downloadFile(fileId) {
                const file = this.getFileById(fileId);
                if (file) {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = file.content;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },

            saveToStorage() {
                localStorage.setItem('certificateFiles', JSON.stringify(this.files));
            }
        };

        // 统计分析管理
        const StatisticsManager = {
            // 生成船级社费用统计图表
            generateSocietyStatsChart() {
                const stats = CertificateManager.getClassificationSocietyStats();
                const societies = Object.keys(stats).filter(society => stats[society].count > 0);
                
                if (societies.length === 0) {
                    return '<div class="text-center py-8 text-gray-500">暂无数据</div>';
                }

                let chartHtml = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="chart-container p-6 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-4">各船级社证书数量</h4>
                            <div class="space-y-3">
                `;

                societies.forEach(society => {
                    const percentage = (stats[society].count / CertificateManager.certificates.length * 100).toFixed(1);
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">${society}</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">${stats[society].count} 张</span>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                            </div>
                        </div>
                        
                        <div class="chart-container p-6 rounded-xl border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-4">各船级社费用统计</h4>
                            <div class="space-y-3">
                `;

                societies.forEach(society => {
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">${society}</span>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium text-green-600">¥${stats[society].totalAmount.toFixed(2)}</span>
                                <span class="text-xs text-gray-500">均: ¥${stats[society].averageAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                            </div>
                        </div>
                    </div>
                `;

                return chartHtml;
            },

            // 生成月度统计图表
            generateMonthlyStatsChart() {
                const monthlyStats = CertificateManager.getMonthlyStats();
                
                if (monthlyStats.length === 0) {
                    return '<div class="text-center py-8 text-gray-500">暂无月度数据</div>';
                }

                let chartHtml = `
                    <div class="chart-container p-6 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-4">月度费用趋势</h4>
                        <div class="space-y-4">
                `;

                const maxAmount = Math.max(...monthlyStats.map(stat => stat.totalAmount));
                
                monthlyStats.forEach(stat => {
                    const percentage = (stat.totalAmount / maxAmount * 100).toFixed(1);
                    chartHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700 w-20">${stat.month}</span>
                            <div class="flex-1 mx-4">
                                <div class="bg-gray-200 rounded-full h-3">
                                    <div class="bg-green-600 h-3 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="text-right w-32">
                                <div class="text-sm font-medium text-gray-900">¥${stat.totalAmount.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">${stat.count} 张证书</div>
                            </div>
                        </div>
                    `;
                });

                chartHtml += `
                        </div>
                    </div>
                `;

                return chartHtml;
            },

            // 生成费用汇总统计
            generateSummaryStats() {
                const stats = CertificateManager.getClassificationSocietyStats();
                const totalAmount = Object.values(stats).reduce((sum, society) => sum + society.totalAmount, 0);
                const totalCertificates = CertificateManager.certificates.length;
                const averageAmount = totalCertificates > 0 ? totalAmount / totalCertificates : 0;

                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">总证书数量</p>
                                    <p class="text-2xl font-bold">${totalCertificates}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-file-text text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">总费用金额</p>
                                    <p class="text-2xl font-bold">¥${totalAmount.toFixed(2)}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-money text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">平均费用</p>
                                    <p class="text-2xl font-bold">¥${averageAmount.toFixed(2)}</p>
                                </div>
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <i class="fa fa-bar-chart text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // 系统状态管理
        const SystemState = {
            sidebarCollapsed: false,
            currentPage: 'certificate-list',
            currentFiles: [],
            searchQuery: '',
            currentCertificateId: null,

            init() {
                // 先显示登录页面
                AuthSystem.showLoginPage();
                
                this.setupEventListeners();
            },

            setupEventListeners() {
                // 登录表单
                document.getElementById('login-form').addEventListener('submit', this.handleLogin.bind(this));
                document.getElementById('toggle-password').addEventListener('click', this.togglePasswordVisibility);
                document.getElementById('logout-btn').addEventListener('click', () => {
                    AuthSystem.logout();
                });

                // 侧边栏导航
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.loadPage(page);
                    });
                });

                // 证书表单事件
                document.getElementById('close-certificate-modal').addEventListener('click', () => {
                    this.hideAddCertificateModal();
                });

                document.getElementById('cancel-certificate').addEventListener('click', () => {
                    this.hideAddCertificateModal();
                });

                document.getElementById('save-certificate').addEventListener('click', () => {
                    this.saveCertificate();
                });

                // 自动计算金额
                document.getElementById('quantity').addEventListener('input', () => {
                    this.calculateTotalAmount();
                });

                document.getElementById('unit-price').addEventListener('input', () => {
                    this.calculateTotalAmount();
                });

                document.getElementById('auto-calculate').addEventListener('change', () => {
                    this.calculateTotalAmount();
                });

                // 证书编号验证
                document.getElementById('certificate-number').addEventListener('blur', () => {
                    this.validateCertificateNumber();
                });

                // 文件上传事件
                this.setupFileUpload();

                // 证书详情模态框
                document.getElementById('close-detail-modal').addEventListener('click', () => {
                    this.hideCertificateDetailModal();
                });

                document.getElementById('close-detail-btn').addEventListener('click', () => {
                    this.hideCertificateDetailModal();
                });

                // 状态处理模态框
                document.getElementById('close-status-modal').addEventListener('click', () => {
                    this.hideStatusModal();
                });

                document.getElementById('cancel-status').addEventListener('click', () => {
                    this.hideStatusModal();
                });

                document.getElementById('save-status').addEventListener('click', () => {
                    this.saveStatus();
                });
            },

            setupFileUpload() {
                const dropArea = document.getElementById('file-drop-area');
                const fileInput = document.getElementById('certificate-files');

                // 点击选择文件
                dropArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // 文件选择变化
                fileInput.addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });

                // 拖放功能
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.add('file-drag-over');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.remove('file-drag-over');
                    }, false);
                });

                dropArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    this.handleFileUpload(files);
                });
            },

            async handleLogin(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('login-button');
                const loginSpinner = document.getElementById('login-spinner');
                const loginError = document.getElementById('login-error');

                loginButton.disabled = true;
                loginSpinner.classList.remove('hidden');
                loginError.classList.add('hidden');

                try {
                    await AuthSystem.login(username, password);
                    AuthSystem.showMainSystem();
                    this.loadPage('certificate-list');
                } catch (error) {
                    loginError.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginSpinner.classList.add('hidden');
                }
            },

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('password');
                const toggleButton = document.getElementById('toggle-password');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleButton.innerHTML = '<i class="fa fa-eye"></i>';
                } else {
                    passwordInput.type = 'password';
                    toggleButton.innerHTML = '<i class="fa fa-eye-slash"></i>';
                }
            },

            toggleSidebar() {
                this.sidebarCollapsed = !this.sidebarCollapsed;
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');

                if (this.sidebarCollapsed) {
                    sidebar.classList.remove('w-64');
                    sidebar.classList.add('w-16');
                    mainContent.classList.add('ml-16');
                    mainContent.classList.remove('ml-64');
                } else {
                    sidebar.classList.remove('w-16');
                    sidebar.classList.add('w-64');
                    mainContent.classList.remove('ml-16');
                    mainContent.classList.add('ml-64');
                }
            },

            loadPage(page) {
                this.currentPage = page;
                
                // 更新导航状态
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active', 'bg-blue-50', 'text-blue-600');
                    if (item.getAttribute('data-page') === page) {
                        item.classList.add('active', 'bg-blue-50', 'text-blue-600');
                    }
                });

                // 加载页面内容
                const content = this.generatePageContent(page);
                document.getElementById('page-content').innerHTML = content;
                document.getElementById('page-content').classList.add('fade-in');

                setTimeout(() => {
                    document.getElementById('page-content').classList.remove('fade-in');
                }, 500);
            },

            generatePageContent(page) {
                switch(page) {
                    case 'certificate-list':
                        return this.generateCertificateList();
                    case 'add-certificate':
                        this.showAddCertificateModal();
                        return this.generateCertificateList();
                    case 'statistics':
                        return this.generateStatisticsPage();
                    default:
                        return this.generateCertificateList();
                }
            },

            generateStatisticsPage() {
                return `
                    <div class="max-w-7xl mx-auto">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">船级社费用统计</h2>
                                <p class="text-gray-600 mt-1">查看各船级社的费用分布和统计信息</p>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 lg:mt-0">
                                <button onclick="SystemState.exportStatistics()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                    <i class="fa fa-download mr-2"></i>导出统计
                                </button>
                            </div>
                        </div>

                        ${StatisticsManager.generateSummaryStats()}
                        ${StatisticsManager.generateSocietyStatsChart()}
                        ${StatisticsManager.generateMonthlyStatsChart()}
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">详细费用明细</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">船级社</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书数量</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总费用</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均费用</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${this.generateStatisticsTable()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            generateStatisticsTable() {
                const stats = CertificateManager.getClassificationSocietyStats();
                const totalAmount = Object.values(stats).reduce((sum, society) => sum + society.totalAmount, 0);
                const societies = Object.keys(stats).filter(society => stats[society].count > 0);
                
                if (societies.length === 0) {
                    return `
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                <i class="fa fa-bar-chart text-3xl mb-3 block"></i>
                                暂无统计数据
                            </td>
                        </tr>
                    `;
                }

                return societies.map(society => {
                    const percentage = totalAmount > 0 ? (stats[society].totalAmount / totalAmount * 100).toFixed(1) : 0;
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${society}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${stats[society].count} 张</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-green-600">¥${stats[society].totalAmount.toFixed(2)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">¥${stats[society].averageAmount.toFixed(2)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${percentage}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            exportStatistics() {
                // 在实际应用中，这里应该生成Excel或PDF报告
                alert('统计报告导出功能将在实际应用中实现');
            },

            generateCertificateList() {
                const certificates = this.searchQuery ? 
                    CertificateManager.search(this.searchQuery) : 
                    CertificateManager.getAll();
                    
                const canAddCertificate = AuthSystem.currentUser.role === 'admin' || AuthSystem.currentUser.role === 'user';

                // 更新证书数量
                document.getElementById('cert-count').textContent = certificates.length;

                return `
                    <div class="max-w-7xl mx-auto">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">证书列表</h2>
                                <p class="text-gray-600 mt-1">管理和查看所有证书登记信息</p>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 lg:mt-0">
                                <div class="relative">
                                    <input type="text" id="search-input" placeholder="搜索证书编号、产品名称、客户名称..." 
                                        value="${this.searchQuery}"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full lg:w-80">
                                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                                ${canAddCertificate ? `
                                <button onclick="SystemState.showAddCertificateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center">
                                    <i class="fa fa-plus mr-2"></i>新增证书
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">总证书数</p>
                                        <p class="text-2xl font-bold text-gray-800">${certificates.length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-file-text text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">待处理</p>
                                        <p class="text-2xl font-bold text-orange-600">${certificates.filter(c => c.status === 'pending').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-clock-o text-orange-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">已完成</p>
                                        <p class="text-2xl font-bold text-green-600">${certificates.filter(c => c.status === 'completed').length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-check text-green-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">有附件</p>
                                        <p class="text-2xl font-bold text-purple-600">${certificates.filter(c => FileManager.getFilesByCertificate(c.id).length > 0).length}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fa fa-paperclip text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${this.searchQuery ? `
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fa fa-info-circle text-blue-500 mr-2"></i>
                                    <span class="text-blue-700">搜索关键词: "${this.searchQuery}"，找到 ${certificates.length} 条记录</span>
                                </div>
                                <button onclick="SystemState.clearSearch()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fa fa-times mr-1"></i>清除搜索
                                </button>
                            </div>
                        </div>
                        ` : ''}

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">船级社</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">证书编号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">产品名称</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户名称</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">产品型号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">编号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${certificates.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                                <i class="fa fa-folder-open text-3xl mb-3 block"></i>
                                                ${this.searchQuery ? '没有找到匹配的证书' : '暂无证书数据'}
                                                ${canAddCertificate && !this.searchQuery ? '<br><button onclick="SystemState.showAddCertificateModal()" class="text-blue-600 hover:text-blue-800 mt-2">点击添加第一个证书</button>' : ''}
                                            </td>
                                        </tr>
                                        ` : certificates.map(cert => {
                                            const files = FileManager.getFilesByCertificate(cert.id);
                                            const statusClass = this.getStatusClass(cert.status);
                                            const statusText = this.getStatusText(cert.status);
                                            return `
                                        <tr class="table-row-hover transition-all">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${new Date(cert.applicationTime).toLocaleString()}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900">${cert.classificationSociety || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900">${cert.certificateNumber}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900">${cert.productName}</div>
                                                ${cert.model ? `<div class="text-xs text-gray-500">型号: ${cert.model}</div>` : ''}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900">${cert.customerName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.model || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.productNumber || '-'}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-900">${cert.quantity}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                                    ${statusText}
                                                </span>
                                                ${files.length > 0 ? `
                                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800">
                                                    <i class="fa fa-paperclip mr-1"></i>${files.length}
                                                </span>
                                                ` : ''}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <div class="flex justify-end space-x-2">
                                                    ${files.length > 0 ? `
                                                    <button class="text-green-600 hover:text-green-800" onclick="SystemState.downloadAllFiles(${cert.id})" title="下载所有文件">
                                                        <i class="fa fa-download"></i>
                                                    </button>
                                                    ` : ''}
                                                    <button class="text-blue-600 hover:text-blue-800" onclick="SystemState.showCertificateDetail(${cert.id})" title="查看详情">
                                                        <i class="fa fa-eye"></i>
                                                    </button>
                                                    ${AuthSystem.currentUser.role === 'admin' ? `
                                                    <button class="text-purple-600 hover:text-purple-800" onclick="SystemState.showStatusModal(${cert.id})" title="更新状态">
                                                        <i class="fa fa-refresh"></i>
                                                    </button>
                                                    <button class="text-red-600 hover:text-red-800" onclick="SystemState.deleteCertificate(${cert.id})" title="删除证书">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <script>
                        // 搜索功能
                        document.getElementById('search-input').addEventListener('input', function(e) {
                            const query = e.target.value.trim();
                            SystemState.searchQuery = query;
                            SystemState.loadPage('certificate-list');
                        });
                    <\/script>
                `;
            },

            getStatusClass(status) {
                switch(status) {
                    case 'pending': return 'status-pending';
                    case 'processing': return 'status-processing';
                    case 'completed': return 'status-completed';
                    case 'rejected': return 'status-rejected';
                    default: return 'status-pending';
                }
            },

            getStatusText(status) {
                switch(status) {
                    case 'pending': return '待处理';
                    case 'processing': return '处理中';
                    case 'completed': return '已完成';
                    case 'rejected': return '已驳回';
                    default: return '待处理';
                }
            },

            showAddCertificateModal() {
                const modal = document.getElementById('add-certificate-modal');
                const form = document.getElementById('certificate-form');
                
                form.reset();
                this.currentFiles = [];
                this.updateFileList();
                
                // 设置默认时间
                const now = new Date();
                const localDateTime = now.toISOString().slice(0, 16);
                document.getElementById('application-time').value = localDateTime;
                
                modal.classList.remove('hidden');
            },

            hideAddCertificateModal() {
                const modal = document.getElementById('add-certificate-modal');
                modal.classList.add('hidden');
            },

            showCertificateDetail(id) {
                const certificate = CertificateManager.getById(id);
                if (!certificate) return;

                const files = FileManager.getFilesByCertificate(id);
                const modal = document.getElementById('certificate-detail-modal');
                const content = document.getElementById('certificate-detail-content');

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">基本信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">申请时间:</span>
                                        <span class="font-medium">${new Date(certificate.applicationTime).toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">船级社:</span>
                                        <span class="font-medium">${certificate.classificationSociety || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">证书编号:</span>
                                        <span class="font-medium">${certificate.certificateNumber}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">产品名称:</span>
                                        <span class="font-medium">${certificate.productName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">客户名称:</span>
                                        <span class="font-medium">${certificate.customerName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">产品型号:</span>
                                        <span class="font-medium">${certificate.model || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">编号:</span>
                                        <span class="font-medium">${certificate.productNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">数量:</span>
                                        <span class="font-medium">${certificate.quantity}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">状态:</span>
                                        <span class="font-medium ${this.getStatusClass(certificate.status)} px-2 py-1 rounded-full text-xs">${this.getStatusText(certificate.status)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">产品规格</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">型号:</span>
                                        <span class="font-medium">${certificate.model || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">功率:</span>
                                        <span class="font-medium">${certificate.power || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">编号:</span>
                                        <span class="font-medium">${certificate.productNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">计划号:</span>
                                        <span class="font-medium">${certificate.planNumber || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">合同号:</span>
                                        <span class="font-medium">${certificate.contractNumber || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">价格信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">数量:</span>
                                        <span class="font-medium">${certificate.quantity}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">价格计算标准:</span>
                                        <span class="font-medium">${certificate.priceStandard || '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">单价:</span>
                                        <span class="font-medium">${certificate.unitPrice ? '¥' + certificate.unitPrice.toFixed(2) : '-'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">合计金额:</span>
                                        <span class="font-medium text-blue-600">${certificate.totalAmount ? '¥' + certificate.totalAmount.toFixed(2) : '-'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="certificate-detail p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">系统信息</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">创建人:</span>
                                        <span class="font-medium">${certificate.createdBy}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">创建时间:</span>
                                        <span class="font-medium">${new Date(certificate.createdAt).toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">附件数量:</span>
                                        <span class="font-medium">${files.length} 个文件</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${certificate.remarks ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">备注</h4>
                            <p class="text-sm text-gray-700">${certificate.remarks}</p>
                        </div>
                        ` : ''}
                        
                        ${files.length > 0 ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">附件文件</h4>
                            <div class="space-y-2">
                                ${files.map(file => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <div class="flex items-center">
                                        <i class="fa ${this.getFileIcon(file.type)} text-blue-600 mr-3"></i>
                                        <div>
                                            <div class="text-sm font-medium">${file.name}</div>
                                            <div class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB • ${new Date(file.uploadTime).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-500">上传者: ${file.uploadedBy}</span>
                                        <button class="text-green-600 hover:text-green-800 ml-2" onclick="FileManager.downloadFile(${file.id})" title="下载文件">
                                            <i class="fa fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${certificate.statusHistory && certificate.statusHistory.length > 0 ? `
                        <div class="certificate-detail p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3 border-b pb-2">状态历史</h4>
                            <div class="space-y-3">
                                ${certificate.statusHistory.map(history => `
                                <div class="flex items-start space-x-3 p-2 bg-white rounded border">
                                    <div class="w-2 h-2 mt-2 rounded-full ${this.getStatusClass(history.status)}"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <span class="font-medium ${this.getStatusClass(history.status)} px-2 py-1 rounded-full text-xs">${this.getStatusText(history.status)}</span>
                                            <span class="text-xs text-gray-500">${new Date(history.changedAt).toLocaleString()}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">操作人: ${history.changedBy}</div>
                                        ${history.remarks ? `<div class="text-sm text-gray-700 mt-1">说明: ${history.remarks}</div>` : ''}
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.classList.remove('hidden');
            },

            hideCertificateDetailModal() {
                const modal = document.getElementById('certificate-detail-modal');
                modal.classList.add('hidden');
            },

            showStatusModal(certificateId) {
                this.currentCertificateId = certificateId;
                const certificate = CertificateManager.getById(certificateId);
                const modal = document.getElementById('status-modal');
                
                if (certificate) {
                    document.getElementById('status-select').value = certificate.status;
                }
                
                modal.classList.remove('hidden');
            },

            hideStatusModal() {
                const modal = document.getElementById('status-modal');
                modal.classList.add('hidden');
                this.currentCertificateId = null;
            },

            saveStatus() {
                if (!this.currentCertificateId) return;

                const newStatus = document.getElementById('status-select').value;
                const remarks = document.getElementById('status-remarks').value;

                if (CertificateManager.updateStatus(this.currentCertificateId, newStatus, remarks)) {
                    alert('状态更新成功！');
                    this.hideStatusModal();
                    this.loadPage('certificate-list');
                } else {
                    alert('状态更新失败！');
                }
            },

            downloadAllFiles(certificateId) {
                const files = FileManager.getFilesByCertificate(certificateId);
                if (files.length === 0) {
                    alert('该证书没有附件文件');
                    return;
                }

                // 在实际应用中，这里应该打包下载所有文件
                // 这里我们只下载第一个文件作为示例
                if (files.length > 0) {
                    FileManager.downloadFile(files[0].id);
                }
                
                if (files.length > 1) {
                    alert(`已开始下载第一个文件，共 ${files.length} 个文件。在实际应用中，这里应该提供批量下载功能。`);
                }
            },

            validateCertificateNumber() {
                const numberInput = document.getElementById('certificate-number');
                const errorDiv = document.getElementById('certificate-number-error');
                const number = numberInput.value.trim();

                if (number && CertificateManager.certificateNumberExists(number)) {
                    errorDiv.classList.remove('hidden');
                    return false;
                } else {
                    errorDiv.classList.add('hidden');
                    return true;
                }
            },

            calculateTotalAmount() {
                const autoCalculate = document.getElementById('auto-calculate').checked;
                const totalAmountInput = document.getElementById('total-amount');

                if (autoCalculate) {
                    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                    const unitPrice = parseFloat(document.getElementById('unit-price').value) || 0;
                    const totalAmount = quantity * unitPrice;
                    totalAmountInput.value = totalAmount.toFixed(2);
                }
            },

            handleFileUpload(files) {
                Array.from(files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`文件 ${file.name} 超过10MB限制`);
                        return;
                    }

                    // 检查文件类型
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                    if (!allowedTypes.includes(file.type)) {
                        alert(`文件 ${file.name} 格式不支持`);
                        return;
                    }

                    this.currentFiles.push(file);
                });

                this.updateFileList();
            },

            updateFileList() {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                this.currentFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fa ${this.getFileIcon(file.type)} text-blue-600 mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-gray-800">${file.name}</div>
                                <div class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                            </div>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="SystemState.removeFile(${index})">
                            <i class="fa fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
            },

            getFileIcon(fileType) {
                if (fileType === 'application/pdf') return 'fa-file-pdf-o';
                if (fileType.startsWith('image/')) return 'fa-file-image-o';
                if (fileType.includes('word')) return 'fa-file-word-o';
                return 'fa-file-o';
            },

            removeFile(index) {
                this.currentFiles.splice(index, 1);
                this.updateFileList();
            },

            async saveCertificate() {
                if (!this.validateCertificateForm()) {
                    alert('请填写所有必填字段');
                    return;
                }

                if (!this.validateCertificateNumber()) {
                    alert('证书编号已存在');
                    return;
                }

                const certificateData = {
                    certificateNumber: document.getElementById('certificate-number').value.trim(),
                    applicationTime: document.getElementById('application-time').value,
                    productName: document.getElementById('product-name').value.trim(),
                    customerName: document.getElementById('customer-name').value.trim(),
                    planNumber: document.getElementById('plan-number').value.trim(),
                    contractNumber: document.getElementById('contract-number').value.trim(),
                    classificationSociety: document.getElementById('classification-society').value,
                    model: document.getElementById('model').value.trim(),
                    power: document.getElementById('power').value.trim(),
                    productNumber: document.getElementById('product-number').value.trim(),
                    quantity: parseInt(document.getElementById('quantity').value),
                    priceStandard: document.getElementById('price-standard').value.trim(),
                    unitPrice: parseFloat(document.getElementById('unit-price').value) || 0,
                    totalAmount: parseFloat(document.getElementById('total-amount').value) || 0,
                    remarks: document.getElementById('remarks').value.trim(),
                    status: document.getElementById('status').value
                };

                try {
                    const saveBtn = document.getElementById('save-certificate');
                    saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>保存中...';
                    saveBtn.disabled = true;

                    // 保存证书
                    const newCertificate = CertificateManager.add(certificateData);

                    // 保存文件
                    this.currentFiles.forEach(file => {
                        FileManager.addFile(newCertificate.id, file);
                    });

                    saveBtn.innerHTML = '<i class="fa fa-save mr-2"></i>保存证书';
                    saveBtn.disabled = false;

                    alert('证书保存成功！');
                    this.hideAddCertificateModal();
                    this.loadPage('certificate-list');

                } catch (error) {
                    alert('证书保存失败，请重试');
                    console.error('保存证书失败:', error);
                }
            },

            validateCertificateForm() {
                const requiredFields = [
                    'certificate-number',
                    'application-time',
                    'product-name',
                    'customer-name',
                    'quantity'
                ];

                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        return false;
                    }
                }

                const quantity = document.getElementById('quantity');
                if (quantity.value && parseInt(quantity.value) < 1) {
                    return false;
                }

                return true;
            },

            deleteCertificate(id) {
                if (confirm('确定要删除这个证书吗？此操作不可撤销。')) {
                    CertificateManager.delete(id);
                    this.loadPage('certificate-list');
                    alert('证书删除成功！');
                }
            },

            clearSearch() {
                this.searchQuery = '';
                this.loadPage('certificate-list');
            }
        };

        // 初始化系统
        document.addEventListener('DOMContentLoaded', () => {
            SystemState.init();
        });
    </script>
</body>
</html>
    
